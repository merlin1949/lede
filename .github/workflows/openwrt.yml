# ==============================================================
# OpenWrt è‡ªåŠ¨åŒ–ç¼–è¯‘é…ç½®æ–‡ä»¶ (æœ€ç»ˆä¿®å¤ç‰ˆ)
# æ›´æ–°æ—¥æœŸï¼š2024-04-20
# ä¿®å¤å†…å®¹ï¼šç¯å¢ƒå˜é‡ä½œç”¨åŸŸé—®é¢˜
# ==============================================================

name: ğŸš€ OpenWrt CI/CD Pipeline

on:
  workflow_dispatch:    # å…è®¸åœ¨GitHubç½‘é¡µæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # ä»…ç›‘å¬mainåˆ†æ”¯çš„ä»£ç æ¨é€

jobs:
  build:
    name: ğŸ› ï¸ ç¼–è¯‘å›ºä»¶
    runs-on: ubuntu-22.04    # ä½¿ç”¨Ubuntu 22.04é•œåƒ
    timeout-minutes: 360     # è¶…æ—¶æ—¶é—´è®¾ä¸º6å°æ—¶

    # ========== ç¯å¢ƒå˜é‡å¿…é¡»å®šä¹‰åœ¨jobså±‚çº§ ==========
    env:
      CCACHE_DIR: /tmp/ccache
      TARGET: x86
      SUBTARGET: 64
      FIRMWARE_DIR: "bin/targets/x86/64"  # ç›´æ¥å†™æ­»è·¯å¾„é¿å…è¡¨è¾¾å¼é—®é¢˜

    steps:
    # -------------------------------------------------------------------
    # é˜¶æ®µ1ï¼šä»£ç ä»“åº“åˆå§‹åŒ–
    # -------------------------------------------------------------------
    - name: ğŸ”„ æ‹‰å–æºç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    # -------------------------------------------------------------------
    # é˜¶æ®µ2ï¼šç¼“å­˜ç®¡ç†ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰
    # -------------------------------------------------------------------
    - name: ğŸ“¦ åŠ è½½ç¼“å­˜
      uses: actions/cache@v3
      id: build_cache
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          dl
          build_dir
          staging_dir
        # æ­£ç¡®å¼•ç”¨ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ job å±‚çº§çš„ envï¼‰
        key: ${{ runner.os }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ hashFiles('.config') }}-v25

    # ...ï¼ˆåç»­æ­¥éª¤ä¿æŒä¸å˜ï¼Œæ‰€æœ‰ $FIRMWARE_DIR æ”¹ä¸º ${{ env.FIRMWARE_DIR }}ï¼‰...
