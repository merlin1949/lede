# ==============================================================
# OpenWrt è‡ªåŠ¨åŒ–ç¼–è¯‘é…ç½®æ–‡ä»¶ (æœ€ç»ˆç¨³å®šç‰ˆ)
# åŠŸèƒ½ï¼šäº‘ç«¯ç¼–è¯‘x86_64å›ºä»¶ï¼Œæ”¯æŒæ’ä»¶å®šåˆ¶/ç¼“å­˜åŠ é€Ÿ/é”™è¯¯è°ƒè¯•
# æ›´æ–°æ—¥æœŸï¼š2024-04-20
# ==============================================================

name: ğŸš€ OpenWrt CI/CD Pipeline

on:
  workflow_dispatch:    # å…è®¸åœ¨GitHubç½‘é¡µæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # ä»…ç›‘å¬mainåˆ†æ”¯çš„ä»£ç æ¨é€

env:
  CCACHE_DIR: /tmp/ccache    # CCacheç¼“å­˜ç›®å½•ï¼ˆåŠ é€Ÿé‡å¤ç¼–è¯‘ï¼‰
  TARGET: x86               # ç›®æ ‡è®¾å¤‡æ¶æ„
  SUBTARGET: 64             # å­æ¶æ„ç±»å‹
  FIRMWARE_DIR: "bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"  # å›ºä»¶è¾“å‡ºè·¯å¾„

jobs:
  build:
    name: ğŸ› ï¸ ç¼–è¯‘å›ºä»¶
    runs-on: ubuntu-22.04    # ä½¿ç”¨Ubuntu 22.04é•œåƒ
    timeout-minutes: 360     # è¶…æ—¶æ—¶é—´è®¾ä¸º6å°æ—¶ï¼ˆåº”å¯¹å¤§å‹ç¼–è¯‘ï¼‰

    steps:
    # -------------------------------------------------------------------
    # é˜¶æ®µ1ï¼šä»£ç ä»“åº“åˆå§‹åŒ–
    # -------------------------------------------------------------------
    - name: ğŸ”„ æ‹‰å–æºç 
      uses: actions/checkout@v4
      with:
        submodules: recursive  # é€’å½’å…‹éš†å­æ¨¡å—ï¼ˆå¿…é¡»ï¼‰
        fetch-depth: 1         # åªæ‹‰å–æœ€è¿‘ä¸€æ¬¡æäº¤ï¼ˆåŠ é€Ÿå…‹éš†ï¼‰

    # -------------------------------------------------------------------
    # é˜¶æ®µ2ï¼šç¼“å­˜ç®¡ç†ï¼ˆèŠ‚çœ90%+ç¼–è¯‘æ—¶é—´ï¼‰
    # -------------------------------------------------------------------
    - name: ğŸ“¦ åŠ è½½ç¼“å­˜
      uses: actions/cache@v3
      id: build_cache
      with:
        path: |
          ${{ env.CCACHE_DIR }}  # ç¼–è¯‘ç¼“å­˜
          dl                     # é¢„ä¸‹è½½çš„è½¯ä»¶åŒ…
          build_dir              # ä¸­é—´ç¼–è¯‘æ–‡ä»¶
          staging_dir            # å·¥å…·é“¾ç¼“å­˜
        key: ${{ runner.os }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ hashFiles('.config') }}-v25

    # -------------------------------------------------------------------
    # é˜¶æ®µ3ï¼šå®‰è£…ç³»ç»Ÿçº§ä¾èµ–
    # -------------------------------------------------------------------
    - name: ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        # åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib gettext git \
          libncurses5-dev libssl-dev python3 python3-pip python3-venv \
          zlib1g-dev file wget jq rsync unzip
        
        # å†…æ ¸æ¨¡å—ç¼–è¯‘ä¾èµ–
        sudo apt-get install -y \
          libelf-dev liblzma-dev lib32z1-dev pkg-config autoconf
        
        # ä¿®å¤Pythonç¯å¢ƒ
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    # -------------------------------------------------------------------
    # é˜¶æ®µ4ï¼šé…ç½®è½¯ä»¶æºï¼ˆFeedsï¼‰
    # -------------------------------------------------------------------
    - name: âš™ï¸ é…ç½®è½¯ä»¶æº
      run: |
        # æ¸…ç©ºåŸæœ‰é…ç½®ï¼ˆé¿å…æ®‹ç•™å½±å“ï¼‰
        > feeds.conf.default

        # æ ¸å¿ƒæºï¼ˆLEDEå®˜æ–¹ï¼‰
        echo 'src-git packages https://github.com/coolsnowwolf/packages' >> feeds.conf.default
        echo 'src-git luci https://github.com/coolsnowwolf/luci' >> feeds.conf.default

        # ç¬¬ä¸‰æ–¹æ’ä»¶æº
        echo 'src-git unblockmusic https://github.com/UnblockNeteaseMusic/luci-app-unblockneteasemusic' >> feeds.conf.default
        echo 'src-git adbyby https://github.com/Adbyby-Team/adbyby-rule' >> feeds.conf.default

        # å¸¦é‡è¯•æœºåˆ¶çš„æ›´æ–°ï¼ˆåº”å¯¹ç½‘ç»œæ³¢åŠ¨ï¼‰
        n=0
        until [ $n -ge 3 ]; do
          ./scripts/feeds update -a && break
          n=$((n+1))
          echo "â— Feedsæ›´æ–°å¤±è´¥ï¼Œç¬¬$næ¬¡é‡è¯•..."
          sleep 15
        done

        # å¼ºåˆ¶å®‰è£…æ‰€æœ‰åŒ…ï¼ˆè¦†ç›–å†²çªï¼‰
        ./scripts/feeds install -a --force

    # -------------------------------------------------------------------
    # é˜¶æ®µ5ï¼šåº”ç”¨ç¼–è¯‘é…ç½®
    # -------------------------------------------------------------------
    - name: âš™ï¸ ç”Ÿæˆé…ç½®
      run: |
        # å­˜åœ¨æ—§é…ç½®æ—¶åˆå¹¶æ›´æ–°
        if [ -f .config ]; then
          echo "ğŸ”§ æ£€æµ‹åˆ°å·²æœ‰é…ç½®ï¼Œæ‰§è¡Œåˆå¹¶..."
          cp .config .config.bak
          make defconfig
          ./scripts/diffconfig.sh >> .config
        else
          echo "ğŸ†• ç”Ÿæˆé»˜è®¤é…ç½®..."
          make defconfig
        fi

        # å¼ºåˆ¶å¯ç”¨å…³é”®é€‰é¡¹
        sed -i 's/# CONFIG_CCACHE is not set/CONFIG_CCACHE=y/' .config
        echo 'CONFIG_CCACHE_DIR="'$CCACHE_DIR'"' >> .config
        echo 'CONFIG_TARGET_ROOTFS_PARTSIZE=2048' >> .config  # è°ƒæ•´åˆ†åŒºå¤§å°

        # å¼€å‘è°ƒè¯•é€‰é¡¹
        echo 'CONFIG_DEBUG=y' >> .config          # å¯ç”¨è°ƒè¯•ç¬¦å·
        echo 'CONFIG_STRIP_KERNEL_EXPORTS=y' >> .config

    # -------------------------------------------------------------------
    # é˜¶æ®µ6ï¼šæ ¸å¿ƒç¼–è¯‘æµç¨‹
    # -------------------------------------------------------------------
    - name: ğŸ”¨ å¼€å§‹ç¼–è¯‘
      run: |
        # åŠ¨æ€è®¡ç®—å¹¶è¡Œä»»åŠ¡æ•°ï¼ˆé¿å…OOMï¼‰
        MAX_CORES=$(nproc)
        SAFE_CORES=$(( MAX_CORES > 4 ? 4 : MAX_CORES ))  # é™åˆ¶æœ€å¤§4çº¿ç¨‹
        
        # å¯åŠ¨ç¼–è¯‘ï¼ˆä¿ç•™è¯¦ç»†æ—¥å¿—ï¼‰
        time make -j$SAFE_CORES \
          CONFIG_CCACHE=y \
          FORCE_UNSAFE_CONFIGURE=1 \
          V=sc 2>&1 | tee build.log
        
        # éªŒè¯å›ºä»¶ç”Ÿæˆ
        if [ ! -f $FIRMWARE_DIR/*.img ]; then
          echo "âŒ è‡´å‘½é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°è¾“å‡ºå›ºä»¶ï¼"
          exit 1
        fi

    # -------------------------------------------------------------------
    # é˜¶æ®µ7ï¼šäº§ç‰©å¤„ç†
    # -------------------------------------------------------------------
    - name: ğŸ“¦ æ‰“åŒ…è¾“å‡º
      run: |
        # åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å‘å¸ƒç›®å½•
        RELEASE_NAME="openwrt_$(date +'%Y%m%d_%H%M')"
        mkdir -p $RELEASE_NAME
        
        # å¤åˆ¶å…³é”®æ–‡ä»¶
        cp $FIRMWARE_DIR/*.{img,sha256sum} $RELEASE_NAME/
        cp build.log $RELEASE_NAME/
        
        # ç”Ÿæˆæ–‡ä»¶æ¸…å•
        ls -lh $RELEASE_NAME > $RELEASE_NAME/filelist.txt
        
        # å‹ç¼©å½’æ¡£ï¼ˆèŠ‚çœç©ºé—´ï¼‰
        tar -czvf $RELEASE_NAME.tar.gz $RELEASE_NAME

    - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-build
        path: |
          *.tar.gz
          !tmp/
        retention-days: 7

    # -------------------------------------------------------------------
    # é˜¶æ®µ8ï¼šå¼‚å¸¸å¤„ç†
    # -------------------------------------------------------------------
    - name: ğŸš¨ ä¸Šä¼ é”™è¯¯æ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          build.log
          tmp/**/*.log
