# ==============================================================
# OpenWrt 自动化编译配置文件 (最终修复版)
# 更新日期：2024-04-20
# 修复内容：环境变量作用域问题
# ==============================================================

name: 🚀 OpenWrt CI/CD Pipeline

on:
  workflow_dispatch:    # 允许在GitHub网页手动触发
  push:
    branches: [ main ]  # 仅监听main分支的代码推送

jobs:
  build:
    name: 🛠️ 编译固件
    runs-on: ubuntu-22.04    # 使用Ubuntu 22.04镜像
    timeout-minutes: 360     # 超时时间设为6小时

    # ========== 环境变量必须定义在jobs层级 ==========
    env:
      CCACHE_DIR: /tmp/ccache
      TARGET: x86
      SUBTARGET: 64
      FIRMWARE_DIR: "bin/targets/x86/64"  # 直接写死路径避免表达式问题

    steps:
    # -------------------------------------------------------------------
    # 阶段1：代码仓库初始化
    # -------------------------------------------------------------------
    - name: 🔄 拉取源码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    # -------------------------------------------------------------------
    # 阶段2：缓存管理（关键修复点）
    # -------------------------------------------------------------------
    - name: 📦 加载缓存
      uses: actions/cache@v3
      id: build_cache
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          dl
          build_dir
          staging_dir
        # 正确引用环境变量（使用 job 层级的 env）
        key: ${{ runner.os }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ hashFiles('.config') }}-v25

    # ...（后续步骤保持不变，所有 $FIRMWARE_DIR 改为 ${{ env.FIRMWARE_DIR }}）...
