# =================================================
# OpenWrt x86 æœ¬åœ° Runner ç¼–è¯‘é…ç½®æ–‡ä»¶ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
# - 2024-04-20 æ›´æ–°
# - ä¿®å¤æ—¥å¿—è®°å½• & å•çº¿ç¨‹ç¼–è¯‘
# =================================================

name: OpenWRT_Local_Runner

on:
  workflow_dispatch:
  push:
    branches: [ master ]

env:
  CCACHE_DIR: /tmp/ccache
  TARGET: x86
  SUBTARGET: 64
  FIRMWARE_DIR: lede/bin/targets/x86/64

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: ğŸ”„ æ‹‰å–æºç 
      uses: actions/checkout@v4
      with:
        path: lede
        submodules: recursive
        fetch-depth: 1  # åªæ‹‰å–æœ€æ–°ç‰ˆæœ¬ï¼ŒåŠ å¿«é€Ÿåº¦

    - name: ğŸ“¦ åŠ è½½ç¼“å­˜
      uses: actions/cache@v3
      id: cache
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          lede/dl  # ä¸ç¼“å­˜ build_dirï¼Œé˜²æ­¢æ—§ç¼“å­˜å¯¼è‡´é”™è¯¯

    - name: ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S apt-get update -y
        echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
        gettext git libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev \
        libelf-dev liblzma-dev lib32z1-dev pkg-config autoconf ncurses-term ncurses-base
        echo "TERM=linux" >> $GITHUB_ENV
        echo "TERMINFO=/usr/share/terminfo" >> $GITHUB_ENV

    - name: ğŸ› ï¸ å®‰è£… po2lmo
      run: |
        cd lede
        if [ -d package/lean/default-settings/tools/po2lmo ]; then
          pushd package/lean/default-settings/tools/po2lmo
          make && sudo make install
          popd
        else
          echo "âŒ po2lmo æºç ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘"
        fi

    - name: âš™ï¸ ç”Ÿæˆé…ç½®
      run: |
        cd lede
        [ -f .config ] && cp .config .config.bak || true
        make defconfig

    - name: ğŸ”¨ å¼€å§‹ç¼–è¯‘ï¼ˆå•çº¿ç¨‹ï¼‰
      run: |
        cd lede
        mkdir -p tmp/work/logs
        set -o pipefail
        time make -j1 V=sc 2>&1 | tee build.log tmp/work/logs/full.log  # æ”¹ä¸ºå•çº¿ç¨‹

        # ç¡®ä¿å›ºä»¶ç”Ÿæˆ
        ls $FIRMWARE_DIR/*.img >/dev/null 2>&1 || (echo "âŒ å›ºä»¶æœªç”Ÿæˆ"; exit 1)

    - name: ğŸ“¦ æ‰“åŒ…è¾“å‡º
      run: |
        cd lede
        RELEASE_NAME="openwrt_x86_$(date +'%Y%m%d_%H%M')"
        mkdir -p $RELEASE_NAME
        cp $FIRMWARE_DIR/*.{img,sha256sum} $RELEASE_NAME/
        cp build.log $RELEASE_NAME/
        tar -czvf $RELEASE_NAME.tar.gz $RELEASE_NAME

    - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86
        path: "lede/*.tar.gz"
        retention-days: 7

    - name: ğŸš¨ ä¸Šä¼ é”™è¯¯æ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          lede/build.log
          lede/tmp/work/logs/*.log
