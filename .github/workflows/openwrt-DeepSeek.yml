# ==============================================================
# OpenWrt è‡ªåŠ¨åŒ–ç¼–è¯‘é…ç½®æ–‡ä»¶ (æœ€ç»ˆéªŒè¯ç‰ˆ)
# æ›´æ–°æ—¥æœŸï¼š2024-04-20
# ä¿®å¤å†…å®¹ï¼šç¼“å­˜è·¯å¾„/ç¯å¢ƒå˜é‡/ä¾èµ–é¡ºåº
# ==============================================================

name: ğŸš€ OpenWrt CI/CD Pipeline

on:
  workflow_dispatch:    # å…è®¸åœ¨GitHubç½‘é¡µæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # ä»…ç›‘å¬mainåˆ†æ”¯çš„ä»£ç æ¨é€

jobs:
  build:
    name: ğŸ› ï¸ ç¼–è¯‘å›ºä»¶
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶

    # ========== ç¯å¢ƒå˜é‡ ==========
    env:
      CCACHE_DIR: /tmp/ccache
      TARGET: x86
      SUBTARGET: 64
      FIRMWARE_DIR: "bin/targets/x86/64"  # å›ºå®šè·¯å¾„é¿å…åµŒå¥—è¡¨è¾¾å¼é—®é¢˜

    steps:
    # -------------------------------------------------------------------
    # é˜¶æ®µ1ï¼šä»£ç ä»“åº“åˆå§‹åŒ–
    # -------------------------------------------------------------------
    - name: ğŸ”„ æ‹‰å–æºç 
      uses: actions/checkout@v4
      with:
        submodules: recursive  # å¿…é¡»å¯ç”¨å­æ¨¡å—é€’å½’å…‹éš†
        fetch-depth: 1         # åŠ é€Ÿå…‹éš†

    # -------------------------------------------------------------------
    # é˜¶æ®µ2ï¼šç¼“å­˜ç®¡ç†ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰
    # -------------------------------------------------------------------
    - name: ğŸ“¦ åŠ è½½ç¼“å­˜
      uses: actions/cache@v3
      id: build_cache
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          dl
          build_dir
        key: ${{ runner.os }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ hashFiles('.config') }}-v26

    # -------------------------------------------------------------------
    # é˜¶æ®µ3ï¼šä¾èµ–å®‰è£…ï¼ˆæ–°å¢ç½‘ç»œé‡è¯•ï¼‰
    # -------------------------------------------------------------------
    - name: ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        # åŸºç¡€ä¾èµ–ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        for i in {1..3}; do
          sudo apt-get update && \
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext git \
            libncurses5-dev libssl-dev python3 python3-pip python3-venv \
            zlib1g-dev file wget jq rsync unzip \
            libelf-dev liblzma-dev lib32z1-dev pkg-config autoconf \
          && break || sleep 30
        done

        # ä¿®å¤Pythonç¯å¢ƒ
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    # -------------------------------------------------------------------
    # é˜¶æ®µ4ï¼šæºç é¢„ä¸‹è½½ï¼ˆç¼“å­˜æœªå‘½ä¸­æ—¶æ‰§è¡Œï¼‰
    # -------------------------------------------------------------------
    - name: âš¡ åˆå§‹åŒ–å·¥å…·é“¾
      if: steps.build_cache.outputs.cache-hit != 'true'
      run: |
        make download -j$(nproc) || make download -j1  # é™çº§é‡è¯•
        make -j$(nproc) tools/install

    # -------------------------------------------------------------------
    # é˜¶æ®µ5ï¼šè½¯ä»¶æºé…ç½®ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
    # -------------------------------------------------------------------
    - name: âš™ï¸ é…ç½®è½¯ä»¶æº
      run: |
        > feeds.conf.default  # æ¸…ç©ºæ—§é…ç½®
        echo 'src-git packages https://github.com/coolsnowwolf/packages' >> feeds.conf.default
        echo 'src-git luci https://github.com/coolsnowwolf/luci' >> feeds.conf.default
        echo 'src-git unblockmusic https://github.com/UnblockNeteaseMusic/luci-app-unblockneteasemusic' >> feeds.conf.default
        echo 'src-git adbyby https://github.com/Adbyby-Team/adbyby-rule' >> feeds.conf.default

        # å¸¦é‡è¯•çš„æ›´æ–°
        n=0
        until [ $n -ge 3 ]; do
          ./scripts/feeds update -a && break
          n=$((n+1))
          sleep 15
        done
        ./scripts/feeds install -a --force

    # -------------------------------------------------------------------
    # é˜¶æ®µ6ï¼šç¼–è¯‘é…ç½®ï¼ˆåˆå¹¶æ–°æ—§é…ç½®ï¼‰
    # -------------------------------------------------------------------
    - name: âš™ï¸ ç”Ÿæˆé…ç½®
      run: |
        if [ -f .config ]; then
          echo "ğŸ”§ åˆå¹¶å·²æœ‰é…ç½®..."
          cp .config .config.bak
          make defconfig
          ./scripts/diffconfig.sh >> .config
        else
          echo "ğŸ†• ç”Ÿæˆé»˜è®¤é…ç½®..."
          make defconfig
        fi

        # å¼ºåˆ¶å¯ç”¨å…³é”®é€‰é¡¹
        sed -i 's/# CONFIG_CCACHE is not set/CONFIG_CCACHE=y/' .config
        echo 'CONFIG_CCACHE_DIR="'$CCACHE_DIR'"' >> .config
        echo 'CONFIG_TARGET_ROOTFS_PARTSIZE=2048' >> .config  # åˆ†åŒºå¤§å°

    # -------------------------------------------------------------------
    # é˜¶æ®µ7ï¼šæ ¸å¿ƒç¼–è¯‘ï¼ˆèµ„æºé™åˆ¶ï¼‰
    # -------------------------------------------------------------------
    - name: ğŸ”¨ å¼€å§‹ç¼–è¯‘
      run: |
        MAX_CORES=$(nproc)
        SAFE_CORES=$(( MAX_CORES > 4 ? 4 : MAX_CORES ))  # é™åˆ¶çº¿ç¨‹æ•°é˜²OOM
        time make -j$SAFE_CORES \
          CONFIG_CCACHE=y \
          FORCE_UNSAFE_CONFIGURE=1 \
          V=sc 2>&1 | tee build.log

        # éªŒè¯è¾“å‡º
        if [ ! -f ${{ env.FIRMWARE_DIR }}/*.img ]; then
          echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆå›ºä»¶æ–‡ä»¶ï¼"
          exit 1
        fi

    # -------------------------------------------------------------------
    # é˜¶æ®µ8ï¼šäº§ç‰©å¤„ç†ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
    # -------------------------------------------------------------------
    - name: ğŸ“¦ æ‰“åŒ…è¾“å‡º
      run: |
        RELEASE_NAME="openwrt_$(date +'%Y%m%d_%H%M')"
        mkdir -p $RELEASE_NAME
        cp ${{ env.FIRMWARE_DIR }}/*.{img,sha256sum} $RELEASE_NAME/
        cp build.log $RELEASE_NAME/
        tar -czvf $RELEASE_NAME.tar.gz $RELEASE_NAME

    - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-build
        path: "*.tar.gz"
        retention-days: 7

    # -------------------------------------------------------------------
    # é˜¶æ®µ9ï¼šå¼‚å¸¸å¤„ç†ï¼ˆæ—¥å¿—æ”¶é›†ï¼‰
    # -------------------------------------------------------------------
    - name: ğŸš¨ ä¸Šä¼ é”™è¯¯æ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          build.log
          tmp/**/*.log
