# ==============================================================
# OpenWrt è‡ªåŠ¨åŒ–ç¼–è¯‘é…ç½®æ–‡ä»¶ (ç»ˆæä¿®å¤ç‰ˆ)
# æ›´æ–°æ—¥æœŸï¼š2024-04-20
# ä¿®å¤å†…å®¹ï¼šä¾èµ–ç¼ºå¤±/æ—¥å¿—è·¯å¾„/ç¼“å­˜é”™è¯¯
# ==============================================================

name: ğŸš€ OpenWrt CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    name: ğŸ› ï¸ ç¼–è¯‘å›ºä»¶
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    env:
      CCACHE_DIR: /tmp/ccache
      TARGET: x86
      SUBTARGET: 64
      FIRMWARE_DIR: "bin/targets/x86/64"  # å›ºå®šè·¯å¾„

    steps:
    # -------------------------------------------------------------------
    # é˜¶æ®µ1ï¼šä»£ç åˆå§‹åŒ–
    # -------------------------------------------------------------------
    - name: ğŸ”„ æ‹‰å–æºç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    # -------------------------------------------------------------------
    # é˜¶æ®µ2ï¼šç¼“å­˜ç®¡ç†
    # -------------------------------------------------------------------
    - name: ğŸ“¦ åŠ è½½ç¼“å­˜
      uses: actions/cache@v3
      id: cache
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          dl
          build_dir
        key: ${{ runner.os }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ hashFiles('.config') }}-v27

    # -------------------------------------------------------------------
    # é˜¶æ®µ3ï¼šç³»ç»Ÿä¾èµ–
    # -------------------------------------------------------------------
    - name: ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        for i in {1..3}; do
          sudo apt-get update && \
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext git \
            libncurses5-dev libssl-dev python3 python3-pip libelf-dev liblzma-dev \
            zlib1g-dev file wget jq rsync unzip autoconf pkg-config \
          && break || sleep 30
        done
        sudo ln -sf /usr/bin/python3 /usr/bin/python

    # -------------------------------------------------------------------
    # é˜¶æ®µ4ï¼šé¢„ä¸‹è½½æºç 
    # -------------------------------------------------------------------
    - name: âš¡ åˆå§‹åŒ–å·¥å…·é“¾
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p dl build_dir
        make download -j$(nproc) || make download -j1

    # -------------------------------------------------------------------
    # é˜¶æ®µ5ï¼šè½¯ä»¶æºé…ç½®
    # -------------------------------------------------------------------
    - name: âš™ï¸ é…ç½®Feeds
      run: |
        cat << EOF > feeds.conf.default
        src-git packages https://github.com/coolsnowwolf/packages
        src-git luci https://github.com/coolsnowwolf/luci
        src-git unblockmusic https://github.com/UnblockNeteaseMusic/luci-app-unblockneteasemusic
        src-git adbyby https://github.com/Adbyby-Team/adbyby-rule
        EOF

        n=0
        until [ $n -ge 3 ]; do
          ./scripts/feeds update -a && break
          n=$((n+1))
          sleep 15
        done
        ./scripts/feeds install -a --force

    # -------------------------------------------------------------------
    # é˜¶æ®µ6ï¼šç¼–è¯‘é…ç½®
    # -------------------------------------------------------------------
    - name: âš™ï¸ ç”Ÿæˆé…ç½®
      run: |
        [ -f .config ] && cp .config .config.bak || true
        make defconfig
        ./scripts/diffconfig.sh > .config

        # å¼ºåˆ¶ä¿®å¤å…³é”®ä¾èµ–
        REQUIRED_DEPS=(
          "CONFIG_PACKAGE_lm-sensors=y"
          "CONFIG_PACKAGE_wsdd2=y"
          "CONFIG_PACKAGE_autosamba=y"
          "CONFIG_PACKAGE_libudev=y"
        )
        for dep in "${REQUIRED_DEPS[@]}"; do
          if ! grep -q "$dep" .config; then
            echo "$dep" >> .config
          fi
        done

        echo 'CONFIG_CCACHE=y' >> .config
        echo "CONFIG_CCACHE_DIR=\"$CCACHE_DIR\"" >> .config

    # -------------------------------------------------------------------
    # é˜¶æ®µ7ï¼šæ ¸å¿ƒç¼–è¯‘
    # -------------------------------------------------------------------
    - name: ğŸ”¨ å¼€å§‹ç¼–è¯‘
      run: |
        mkdir -p tmp/work/logs
        MAX_CORES=$(($(nproc) > 4 ? 4 : $(nproc)))
        
        # å¼ºåˆ¶è®°å½•å®Œæ•´æ—¥å¿—
        set -o pipefail
        time make -j$MAX_CORES V=sc 2>&1 | tee build.log tmp/work/logs/full.log
        
        # éªŒè¯å›ºä»¶å­˜åœ¨æ€§
        [ -f $FIRMWARE_DIR/*.img ] || (echo "âŒ å›ºä»¶æœªç”Ÿæˆ"; exit 1)

    # -------------------------------------------------------------------
    # é˜¶æ®µ8ï¼šäº§ç‰©å¤„ç†
    # -------------------------------------------------------------------
    - name: ğŸ“¦ æ‰“åŒ…è¾“å‡º
      run: |
        RELEASE_NAME="openwrt_$(date +'%Y%m%d_%H%M')"
        mkdir -p $RELEASE_NAME
        cp $FIRMWARE_DIR/*.{img,sha256sum} $RELEASE_NAME/
        cp build.log $RELEASE_NAME/
        tar -czvf $RELEASE_NAME.tar.gz $RELEASE_NAME

    - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-build
        path: "*.tar.gz"
        retention-days: 7

    # -------------------------------------------------------------------
    # é˜¶æ®µ9ï¼šé”™è¯¯å¤„ç†
    # -------------------------------------------------------------------
    - name: ğŸš¨ ä¸Šä¼ é”™è¯¯æ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          build.log
          tmp/work/logs/*.log
