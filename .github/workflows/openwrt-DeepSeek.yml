#!/bin/bash
# ================================
#   diy-part1.sh - OpenWRT è‡ªå®šä¹‰è®¾ç½®
#   âœ… ç¡®ä¿æ‰€æœ‰å‘½ä»¤éƒ½åœ¨å½“å‰ç›®å½•æ‰§è¡Œ
# ================================

echo "ğŸ”§ [diy-part1] å¼€å§‹æ‰§è¡Œ..."

# 1ï¸âƒ£ **æ‹‰å–ç¬¬ä¸‰æ–¹æ’ä»¶**
git clone --depth=1 https://github.com/fw876/helloworld package/helloworld || true
git clone --depth=1 https://github.com/xiaorouji/openwrt-passwall package/passwall || true
git clone --depth=1 https://github.com/kenzok8/openwrt-packages package/kenzok8 || true

# 2ï¸âƒ£ **æ›¿æ¢é»˜è®¤ Netgear ä¸»é¢˜**
rm -rf package/lean/luci-theme-argon || true
git clone --depth=1 https://github.com/i028/luci-theme-netgear package/luci-theme-netgear || true

# 3ï¸âƒ£ **ä¿®æ”¹é»˜è®¤ IP**
mkdir -p package/base-files/files/bin
sed -i 's/192.168.1.1/10.0.0.3/g' package/base-files/files/bin/config_generate || true

# 4ï¸âƒ£ **è®¾ç½®é»˜è®¤ç½‘å…³å’Œ DNS**
sed -i '/uci commit network/i\
uci set network.lan.gateway="10.0.0.1"\ 
uci set network.lan.dns="10.0.0.1"' package/base-files/files/bin/config_generate || true

# 5ï¸âƒ£ **ä¿®æ”¹ OpenWRT ä¸»æœºå**
sed -i 's/hostname=.*/hostname="OpenWRT-Test"/g' package/base-files/files/bin/config_generate || true

# 6ï¸âƒ£ **ä¿®æ”¹é»˜è®¤ WiFi é…ç½®**
mkdir -p package/base-files/files/etc/config
cat <<EOF > package/base-files/files/etc/config/wireless
config wifi-device 'radio0'
	option type 'mac80211'
	option channel 'auto'
	option hwmode '11g'
	option path 'platform/qca953x_wmac'
	option htmode 'HT20'
	option disabled '0'

config wifi-iface 'default_radio0'
	option device 'radio0'
	option mode 'ap'
	option ssid 'OpenWRT-Test'
	option encryption 'psk2'
	option key '12345678'
	option network 'lan'

config wifi-device 'radio1'
	option type 'mac80211'
	option channel 'auto'
	option hwmode '11a'
	option path 'platform/qca953x_wmac'
	option htmode 'VHT40'
	option disabled '0'

config wifi-iface 'default_radio1'
	option device 'radio1'
	option mode 'ap'
	option ssid 'OpenWRT-Test-5G'
	option encryption 'psk2'
	option key '12345678'
	option network 'lan'
EOF

# 7ï¸âƒ£ **ä¿®æ”¹ SSH ç«¯å£**
sed -i 's/option Port 22/option Port 2222/g' package/network/services/dropbear/files/dropbear.config || true

# 8ï¸âƒ£ **å…³é—­ DHCP**
mkdir -p package/base-files/files/etc/config
cat <<EOF > package/base-files/files/etc/config/dhcp
config dnsmasq
	option domainneeded '1'
	option boguspriv '1'
	option filterwin2k '0'
	option localise_queries '1'
	option rebind_protection '1'
	option rebind_localhost '1'
	option local '/lan/'
	option domain 'lan'
	option expandhosts '1'
	option nonegcache '0'
	option authoritative '1'
	option readethers '1'
	option leasefile '/tmp/dhcp.leases'
	option resolvfile '/tmp/resolv.conf.auto'
	option nonwildcard '1'
	option localservice '1'

config dhcp 'lan'
	option interface 'lan'
	option ignore '1'  # å…³é—­DHCP

config dhcp 'wan'
	option interface 'wan'
	option ignore '1'
EOF

echo "âœ… [diy-part1] æ‰§è¡Œå®Œæˆï¼"
