name: Build OpenWrt (Lede)

# è§¦å‘æ–¹å¼ï¼š
# - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
# - å®šæœŸè§¦å‘ (æ¯å‘¨ç¼–è¯‘ä¸€æ¬¡)
on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  schedule:
    - cron: "0 0 * * 0"  # æ¯å‘¨æ—¥ 00:00 è§¦å‘ç¼–è¯‘ (å¯æ ¹æ®éœ€æ±‚è°ƒæ•´)

jobs:
  build:
    runs-on: ubuntu-latest  # GitHub Actions è¿è¡Œç¯å¢ƒ
    container: ubuntu:22.04  # åœ¨ Ubuntu 22.04 å®¹å™¨ä¸­è¿è¡Œï¼Œç¡®ä¿ç¨³å®š

    steps:
      # 1ï¸âƒ£ **æ‹‰å– OpenWrt Lede æºç **
      - name: Checkout Lede Source
        uses: actions/checkout@v4
        with:
          repository: coolsnowwolf/lede  # Lede æºç ä»“åº“
          ref: master  # åˆ†æ”¯
          submodules: recursive  # é€’å½’æ‹‰å–æ‰€æœ‰å­æ¨¡å—ï¼Œé¿å…æ‹‰å–å¤±è´¥
          fetch-depth: 0  # è·å–å®Œæ•´ Git å†å²ï¼Œé¿å… shallow clone å½±å“å­æ¨¡å—
          persist-credentials: false  # é¿å… GitHub API é™åˆ¶ï¼Œç¡®ä¿å®Œæ•´æ‹‰å–

      # 2ï¸âƒ£ **æ‰‹åŠ¨æ‹‰å–å­æ¨¡å—ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰**
      - name: Manually Update Submodules (Fallback)
        run: git submodule update --init --recursive

      # 3ï¸âƒ£ **å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ç¯å¢ƒ**
      - name: Setup Build Environment
        run: |
          apt update && apt install -y \
            build-essential libncurses5-dev gawk git \
            gettext unzip file libssl-dev wget python3 \
            ccache  # ä½¿ç”¨ ccache åŠ é€Ÿé‡å¤ç¼–è¯‘

      # 4ï¸âƒ£ **æ¢å¤ç¼“å­˜ï¼šåŒ…æ‹¬ ccache å’Œ dlï¼ˆä¾èµ–ä¸‹è½½ç›®å½•ï¼‰**
      - name: Restore Cache (DL & ccache)
        uses: actions/cache@v4
        with:
          path: |
            dl  # ä¾èµ–åŒ…ä¸‹è½½ç¼“å­˜
            ~/.ccache  # ç¼–è¯‘ç¼“å­˜
          key: openwrt-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            openwrt-${{ runner.os }}-

      # 5ï¸âƒ£ **æ›´æ–°å¹¶å®‰è£… OpenWrt ç»„ä»¶**
      - name: Update and Install Feeds
        run: |
          ./scripts/feeds update -a  # æ›´æ–° feeds
          ./scripts/feeds install -a  # å®‰è£… feeds ä¸­çš„æ‰€æœ‰è½¯ä»¶åŒ…

      # 6ï¸âƒ£ **åº”ç”¨ `.config` é…ç½®æ–‡ä»¶**
      - name: Apply Custom Config
        run: |
          [ -e .config ] && cp .config .config.backup  # å¤‡ä»½åŸæœ‰ config
          make defconfig  # è§£æ config æ–‡ä»¶ï¼Œç¡®ä¿é…ç½®å®Œæ•´

      # 7ï¸âƒ£ **æå‰ä¸‹è½½æ‰€æœ‰ç¼–è¯‘æ‰€éœ€ä¾èµ–**
      - name: Pre-download Packages (Speed up Build)
        run: make download -j$(nproc) || true  # é¢„ä¸‹è½½ä¾èµ–ï¼Œé¿å…ç¼–è¯‘æ—¶å› ç½‘ç»œé—®é¢˜å¤±è´¥

      # 8ï¸âƒ£ **å¼€å§‹ç¼–è¯‘ OpenWrt**
      - name: Compile OpenWrt
        run: |
          export CCACHE_DIR=~/.ccache  # è®¾ç½® ccache ç›®å½•
          export CONFIG_CCACHE=y  # å¯ç”¨ ccache åŠ é€Ÿç¼–è¯‘
          make -j$(nproc) V=s  # ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒè¿›è¡Œç¼–è¯‘

      # 9ï¸âƒ£ **ä¸Šä¼ ç¼–è¯‘åçš„å›ºä»¶**
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware  # å›ºä»¶åç§°
          path: bin/targets/  # OpenWrt å›ºä»¶è¾“å‡ºç›®å½•
          compression-level: 0  # å…³é—­å‹ç¼©ï¼Œæé«˜ä¸Šä¼ é€Ÿåº¦

      # ğŸ”Ÿ **æ¸…ç†ç¼“å­˜ï¼Œé¿å… GitHub å­˜å‚¨å ç”¨è¿‡å¤š**
      - name: Cleanup Cache (Optional)
        run: |
          rm -rf dl  # åˆ é™¤ä¸‹è½½çš„ä¾èµ–åŒ…ï¼Œé‡Šæ”¾ç©ºé—´
          rm -rf ~/.ccache  # åˆ é™¤ ccache ç¼–è¯‘ç¼“å­˜ï¼Œé˜²æ­¢ GitHub Actions å­˜å‚¨è¢«å æ»¡
