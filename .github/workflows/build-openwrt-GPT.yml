name: Build OpenWrt (Lede)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"

concurrency:
  group: openwrt-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    env:
      TERM: xterm                # å…¨å±€è®¾ç½®ç»ˆç«¯ç±»å‹
      FORCE_UNSAFE_CONFIGURE: 1  # å…¨å±€è®¾ç½®ä¸å®‰å…¨é…ç½®æƒé™

    steps:
      # 1ï¸âƒ£ ç³»ç»Ÿæ£€æŸ¥å’Œç©ºé—´æ¸…ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
      - name: Check System Info
        run: |
          echo "ğŸ” System Check Start"
          df -h
          free -h
          echo "ğŸ§¹ Cleaning system caches..."
          apt clean
          rm -rf /var/lib/apt/lists/*
          journalctl --vacuum-size=50M
          echo "âœ… System Check Completed"

      # 2ï¸âƒ£ å®‰è£…æ ¸å¿ƒå·¥å…·é“¾ï¼ˆä¼˜åŒ–ä¾èµ–é¡¹ï¼‰
      - name: Install Build Tools
        run: |
          apt update && apt install -y \
            build-essential clang flex g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev libelf-dev python3 python3-distutils \
            rsync unzip wget zlib1g-dev ccache ncurses-term
          ccache --max-size=2G  # è®¾ç½®ccacheç¼“å­˜ä¸Šé™

      # 3ï¸âƒ£ æºç å…‹éš†ï¼ˆå¢åŠ å­æ¨¡å—æ·±åº¦ï¼‰
      - name: Clone Lede Repository
        run: |
          git clone --depth=1 --recurse-submodules --shallow-submodules \
            https://github.com/coolsnowwolf/lede.git lede
          cd lede
          git submodule update --init --depth=1

      # 4ï¸âƒ£ é¢„ä¸‹è½½èµ„æºï¼ˆå¢åŠ é‡è¯•æœºåˆ¶ï¼‰
      - name: Pre-download Packages
        run: |
          cd lede
          for i in {1..3}; do
            make download -j$(nproc) && break || sleep 30
          done

      # 5ï¸âƒ£ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œï¼ˆå¢åŠ é”™è¯¯å¤„ç†ï¼‰
      - name: Run Custom Scripts
        run: |
          cd lede
          [ -f diy-part1.sh ] && chmod +x diy-part1.sh && ./diy-part1.sh || true
          [ -f diy-part2.sh ] && chmod +x diy-part2.sh && ./diy-part2.sh || true
          mkdir -p logs  # å¼ºåˆ¶åˆ›å»ºæ—¥å¿—ç›®å½•

      # 6ï¸âƒ£ é…ç½®å¤„ç†ï¼ˆå¢å¼ºå¥å£®æ€§ï¼‰
      - name: Apply Configuration
        run: |
          cd lede
          [ -e .config ] && mv .config .config.bak
          cp ${{ github.workspace }}/.config .   # ä»ä»“åº“åŠ è½½é¢„ç½®é…ç½®
          make defconfig
          ./scripts/diffconfig.sh > config.diff

      # 7ï¸âƒ£ æ ¸å¿ƒç¼–è¯‘æµç¨‹ï¼ˆä¼˜åŒ–èµ„æºä½¿ç”¨ï¼‰
      - name: Compile OpenWrt
        run: |
          cd lede
          echo "ğŸ§  Using $(nproc) threads"
          make -j$(($(nproc) - 1)) V=s 2>&1 | tee build.log
          find bin/ -name '*.img' -ls

      # 8ï¸âƒ£ ç»“æœå¤„ç†ï¼ˆå¤±è´¥æ—¶ä»ä¸Šä¼ æ—¥å¿—ï¼‰
      - name: Post-build Actions
        if: always()
        run: |
          cd lede
          echo "ğŸ“¦ Final disk usage:"
          du -h -d 1
          echo "ğŸ”„ CCache statistics:"
          ccache -s

      # 9ï¸âƒ£ æ™ºèƒ½ä¸Šä¼ ï¼ˆè‡ªåŠ¨æ£€æµ‹äº§ç‰©ï¼‰
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-build-${{ github.run_id }}
          path: |
            lede/bin/targets/**/*.img
            lede/bin/targets/**/*.gz
            lede/config.diff
          retention-days: 3

      # ğŸ”Ÿ æ—¥å¿—æ”¶é›†ï¼ˆå¼ºåˆ¶è·¯å¾„æ£€æµ‹ï¼‰
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: |
            lede/build.log
            lede/logs/**/*
            lede/.config
            lede/.config.bak
