name: Build OpenWrt (Lede)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"

concurrency:
  group: openwrt-build
  cancel-in-progress: true  # **ç¡®ä¿å¤šä¸ªä»»åŠ¡ä¸ä¼šåŒæ—¶è¿è¡Œ**

jobs:
  build:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    steps:
      # 1ï¸âƒ£ **æ£€æŸ¥ GitHub Actions å®¹å™¨ç¯å¢ƒ**
      - name: Check System Info
        run: |
          echo "ğŸ” Checking system environment..."
          which sudo || echo "âš ï¸ sudo not found (not an issue)"
          lsb_release -a || cat /etc/os-release
          df -h
          free -h

      # 2ï¸âƒ£ **å®‰è£… Git**
      - name: Install Git 2.18+
        run: |
          apt update && apt install -y git

      # 3ï¸âƒ£ **æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´**
      - name: Free Disk Space
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc
          docker image prune -a -f
          df -h

      # 4ï¸âƒ£ **å®Œæ•´å…‹éš† Lede æºç **
      - name: Clone Lede Repository
        run: |
          git clone --depth=1 --recurse-submodules https://github.com/coolsnowwolf/lede.git lede
          cd lede
          git submodule update --init --recursive

      # 5ï¸âƒ£ **å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ç¯å¢ƒ**
      - name: Install Dependencies
        run: |
          apt update && apt install -y \
            build-essential libncurses5-dev gawk git rsync \
            gettext unzip file libssl-dev wget python3 \
            python3-distutils ccache libelf-dev

      # 6ï¸âƒ£ **åˆ é™¤æ—§çš„ç¼“å­˜**
      - name: Clean Previous Build Cache
        run: |
          rm -rf lede/tmp
          rm -rf ~/.ccache
          rm -rf lede/dl

      # 7ï¸âƒ£ **æ›´æ–°å¹¶å®‰è£… OpenWrt ç»„ä»¶**
      - name: Update and Install Feeds
        run: |
          cd lede
          ./scripts/feeds update -a  
          ./scripts/feeds install -a  

      # 8ï¸âƒ£ **æå‰ä¸‹è½½æ‰€æœ‰ç¼–è¯‘æ‰€éœ€ä¾èµ–**
      - name: Pre-download Packages
        run: |
          cd lede
          make download -j2 || true  # **ç¡®ä¿ä¸‹è½½æ‰€æœ‰ä¾èµ–**

      # 9ï¸âƒ£ **å…ˆç¼–è¯‘å·¥å…·é“¾ï¼Œé¿å… `world` å¤±è´¥**
      - name: Compile Toolchain
        run: |
          cd lede
          export FORCE_UNSAFE_CONFIGURE=1  
          make tools/install -j2 V=s  

      # ğŸ”Ÿ **è¿è¡Œ diy-part1.sh**
      - name: Run diy-part1.sh
        run: |
          cd lede
          chmod +x diy-part1.sh
          ./diy-part1.sh

      # 1ï¸âƒ£1ï¸âƒ£ **è¿è¡Œ diy-part2.sh**
      - name: Run diy-part2.sh
        run: |
          cd lede
          chmod +x diy-part2.sh
          ./diy-part2.sh

      # 1ï¸âƒ£2ï¸âƒ£ **åº”ç”¨ `.config` é…ç½®æ–‡ä»¶**
      - name: Apply Custom Config
        run: |
          cd lede
          [ -e .config ] && cp .config .config.backup  
          make defconfig  

      # 1ï¸âƒ£3ï¸âƒ£ **å¼€å§‹ç¼–è¯‘ OpenWrt**
      - name: Compile OpenWrt
        run: |
          cd lede
          export FORCE_UNSAFE_CONFIGURE=1  
          export CCACHE_DIR=~/.ccache  
          export CONFIG_CCACHE=y  
          make -j1 V=s  # **é™åˆ¶å¹¶è¡Œä»»åŠ¡ï¼Œå‡å°‘ç£ç›˜å ç”¨**

      # 1ï¸âƒ£4ï¸âƒ£ **ä¸Šä¼ ç¼–è¯‘åçš„å›ºä»¶**
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware  
          path: lede/bin/targets/  
          compression-level: 0  

      # 1ï¸âƒ£5ï¸âƒ£ **ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆæˆåŠŸæˆ–å¤±è´¥éƒ½ä¸Šä¼ ï¼‰**
      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: lede/logs/
