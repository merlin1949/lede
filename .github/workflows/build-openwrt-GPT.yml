name: Build OpenWrt (Lede)

# **è§¦å‘æ–¹å¼**
# - æ‰‹åŠ¨è§¦å‘ (`workflow_dispatch`)
# - å®šæœŸè§¦å‘ (`schedule`)ï¼Œé»˜è®¤æ¯å‘¨æ—¥è‡ªåŠ¨ç¼–è¯‘
on:
  workflow_dispatch:  # **å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ**
  schedule:
    - cron: "0 0 * * 0"  # **æ¯å‘¨æ—¥ 00:00 è§¦å‘ç¼–è¯‘ (å¯è°ƒæ•´)**

jobs:
  build:
    runs-on: ubuntu-latest  # **GitHub Actions æœåŠ¡å™¨**
    container: ubuntu:22.04  # **å›ºå®šä¸º Ubuntu 22.04ï¼Œé¿å… GitHub ç‰ˆæœ¬å˜æ›´**

    steps:
      # 1ï¸âƒ£ **å®‰è£… Git 2.18+ï¼Œç¡®ä¿ `submodules` æ”¯æŒ**
      - name: Install Git 2.18+
        run: |
          apt update && apt install -y git

      # 2ï¸âƒ£ **å®Œæ•´å…‹éš† Lede æºç **
      - name: Clone Lede Repository
        run: |
          git clone --depth=1 --recurse-submodules https://github.com/coolsnowwolf/lede.git lede
          cd lede
          git submodule update --init --recursive

      # 3ï¸âƒ£ **å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ç¯å¢ƒ**
      - name: Install Dependencies
        run: |
          apt update && apt install -y \
            build-essential libncurses5-dev gawk git rsync \
            gettext unzip file libssl-dev wget python3 \
            python3-distutils ccache

      # 4ï¸âƒ£ **æ¢å¤ç¼“å­˜ï¼ˆ`dl` ä¾èµ–åŒ… & `ccache` ç¼–è¯‘ç¼“å­˜ï¼‰**
      - name: Restore Cache (DL & ccache)
        uses: actions/cache@v4
        with:
          path: |
            lede/dl  # **ç¼“å­˜ OpenWrt ä¾èµ–åŒ…**
            ~/.ccache  # **ç¼“å­˜ç¼–è¯‘ç»“æœ**
          key: openwrt-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            openwrt-${{ runner.os }}-

      # 5ï¸âƒ£ **æ›´æ–°å¹¶å®‰è£… OpenWrt ç»„ä»¶**
      - name: Update and Install Feeds
        run: |
          cd lede
          ./scripts/feeds update -a  # **æ›´æ–°æ‰€æœ‰ feeds**
          ./scripts/feeds install -a  # **å®‰è£…æ‰€æœ‰å¯ç”¨çš„ feeds ç»„ä»¶**

      # 6ï¸âƒ£ **åº”ç”¨ `.config` é…ç½®æ–‡ä»¶**
      - name: Apply Custom Config
        run: |
          cd lede
          [ -e .config ] && cp .config .config.backup  # **å¤‡ä»½æ—§é…ç½®**
          make defconfig  # **è§£æé…ç½®ï¼Œç¡®ä¿å®Œæ•´æ€§**

      # 7ï¸âƒ£ **å…ˆç¼–è¯‘å·¥å…·é“¾ï¼Œé¿å… `world` å¤±è´¥**
      - name: Compile Toolchain
        run: |
          cd lede
          export FORCE_UNSAFE_CONFIGURE=1  # **ä¿®å¤ root æƒé™é—®é¢˜**
          make tools/install -j2 V=s  # **é™ä½å¹¶è¡Œç¼–è¯‘çº¿ç¨‹**

      # 8ï¸âƒ£ **æå‰ä¸‹è½½æ‰€æœ‰ç¼–è¯‘æ‰€éœ€ä¾èµ–**
      - name: Pre-download Packages (Speed up Build)
        run: |
          cd lede
          make download -j2 || true  # **é¢„ä¸‹è½½ä¾èµ–ï¼Œé¿å…ç½‘ç»œé—®é¢˜**

      # 9ï¸âƒ£ **å¼€å§‹ç¼–è¯‘ OpenWrtï¼ˆé™ä½å¹¶è¡Œçº¿ç¨‹ï¼Œæé«˜ç¨³å®šæ€§ï¼‰**
      - name: Compile OpenWrt
        run: |
          cd lede
          export FORCE_UNSAFE_CONFIGURE=1  # **ä¿®å¤ root æƒé™é—®é¢˜**
          export CCACHE_DIR=~/.ccache  # **è®¾ç½® ccache ç›®å½•**
          export CONFIG_CCACHE=y  # **å¯ç”¨ ccache åŠ é€Ÿç¼–è¯‘**
          make -j2 V=s  # **é™ä½å¹¶è¡Œçº¿ç¨‹ï¼Œé˜²æ­¢ GitHub è¶…è´Ÿè·**

      # ğŸ”Ÿ **ä¸Šä¼ ç¼–è¯‘åçš„å›ºä»¶**
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware  # **å›ºä»¶åç§°**
          path: lede/bin/targets/  # **OpenWrt å›ºä»¶è¾“å‡ºç›®å½•**
          compression-level: 0  # **å…³é—­å‹ç¼©ï¼ŒåŠ å¿«ä¸Šä¼ **

      # ğŸ”Ÿ **æ¸…ç†ç¼“å­˜ï¼Œé¿å… GitHub å­˜å‚¨å ç”¨è¿‡å¤š**
      - name: Cleanup Cache (Optional)
        run: |
          rm -rf lede/dl  # **åˆ é™¤ä¸‹è½½çš„ä¾èµ–åŒ…**
          rm -rf ~/.ccache  # **åˆ é™¤ ccache ç¼–è¯‘ç¼“å­˜**
